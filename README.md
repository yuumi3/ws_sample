# WebSocket „Çµ„É≥„Éó„É´

WebSocket„Çí‰Ωø„Å£„Å¶React„Ç¢„Éó„É™„ÅÆÂÖ®Âà©Áî®ËÄÖ„Å´ÈÄöÁü•„ÇíË°å„ÅÜ„Çµ„É≥„Éó„É´„Éª„Ç≥„Éº„Éâ„Åß„Åô„ÄÇ

## Ê¶ÇË¶Å

„Åì„ÅÆ„Çµ„É≥„Éó„É´„ÅØ‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å™ÊßãÊàê„Å´„Å™„Å£„Å¶„ÅÑ„Åæ„Åô

1. Admin: ÈÄöÁü•ÊÉÖÂ†±„ÇíÂÖ•Âäõ„ÉªÈÄÅ‰ø°„Åô„ÇãReact„Ç¢„Éó„É™
   - Clear„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„Çµ„Éº„Éê„Éº„Åä„Çà„Å≥ÂÖ®„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅÆÈÄöÁü•„ÅåÊ∂àÂéª„Åï„Çå„Åæ„Åô
2. Client: ÈÄöÁü•„ÇíÂèó„ÅëÂèñ„ÇãReact„Ç¢„Éó„É™
3. Server: WebSocket„ÅÆnode.js„Çµ„Éº„Éê„Éº„Åß„ÄÅAdmin„Åã„ÇâÈÄÅ„Çâ„Çå„Å¶„Åç„ÅüÈÄöÁü•„ÇíÂÖ®Client„Å´ÈÄÅ‰ø°„Åó„Åæ„Åô
   - ÂÖ®Client„Å®„ÅÆWebScketÊé•Á∂ö„ÇíÁÆ°ÁêÜ„Åó„Å¶„ÅÑ„Åæ„Åô
   - Âæå„Åã„ÇâÊé•Á∂ö„Åï„Çå„ÅüClient„Å´„ÇÇÂÖ®ÈÄöÁü•„ÅåÈÄÅ‰ø°„Åï„Çå„Åæ„Åô

![](/images/ws_sample.png)

[WebSocket](https://developer.mozilla.org/ja/docs/Web/API/WebSockets_API)„ÅÆÈÄö‰ø°„Å´„ÅØ‰ª•‰∏ã„ÅÆ„É©„Ç§„Éñ„É©„É™„Éº„Çí‰Ωø„Å£„Å¶„ÅÑ„Åæ„Åô

- React„Ç¢„Éó„É™ÂÅ¥ [React useWebSocket](https://github.com/robtaussig/react-use-websocket)
- „Çµ„Éº„Éê„ÉºÂÅ¥ [ws](https://github.com/websockets/ws)


## „Éï„Ç°„Ç§„É´ÊßãÊàê

```txt
‚îú‚îÄ‚îÄ README.md           „Åì„ÅÆ„Éâ„Ç≠„É•„É°„É≥„Éà
‚îú‚îÄ‚îÄ admin               ÈÄöÁü•ÊÉÖÂ†±„ÇíÂÖ•Âäõ„ÉªÈÄÅ‰ø°„Åô„ÇãReact„Ç¢„Éó„É™
‚îú‚îÄ‚îÄ client              ÈÄöÁü•„ÇíÂèó„ÅëÂèñ„ÇãReact„Ç¢„Éó„É™
‚îú‚îÄ‚îÄ images              „Éâ„Ç≠„É•„É°„É≥„ÉàÁî®ÁîªÂÉè
‚îú‚îÄ‚îÄ maintenance-notice  ÈÄöÁü•„É©„Ç§„Éñ„É©„É™„Éº
‚îî‚îÄ‚îÄ server              WebSocket„ÅÆ„Çµ„Éº„Éê„Éº
```

## „Ç≥„Éº„ÉâËß£Ë™¨

### maintenance-notice

WebSocket„Åß„ÇÑ„ÇäÂèñ„Çä„Åï„Çå„Çã„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂûã„Å®JSON„Å®„ÅÆÂ§âÊèõÈñ¢Êï∞„ÅåÂÆöÁæ©„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ

- index.ts

```ts

// „Çµ„Éº„Éê„Éº„Éª„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅßÂÆüË°å„Åô„Åπ„ÅçÂëΩ‰ª§Ôºà„Ç≥„Éû„É≥„ÉâÔºâ„ÅÆÂûã
//    CLAER : ÈÄöÁü•„ÅÆÊ∂àÂéª
//    NONE  : ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàÁèæÂú®Êú™ÂÆüË£ÖÔºâ
export type MaintenanceCommandType = "CLAER" | "NONE" ;

// ÈÄöÁü•„Éá„Éº„Çø„ÅÆÂûã
export type MaintenanceNoticeType = {
  date: Date,                         // ÈÄÅ‰ø°Êó•ÊôÇ
  message: string,                    // „É°„ÉÉ„Çª„Éº„Ç∏
  command?: MaintenanceCommandType    // ÂÆüË°å„Åô„Åπ„ÅçÂëΩ‰ª§Ôºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
}

// date, message, command „Åã„ÇâÈÄöÁü•Áî®JSON„Çí‰ΩúÊàê
export const maintenanceNoticeToJSon = (date: Date, message: string, command?: MaintenanceCommandType): string => {
  return JSON.stringify({date, message, command});
}

// ÈÄöÁü•Áî®JSON„Åã„ÇâÈÄöÁü•„Éá„Éº„ÇøÂûã„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´Â§âÊèõ
export const jsonToMaintenanceNotice = (json: string): MaintenanceNoticeType => {
  try {
    const obj: MaintenanceNoticeType = JSON.parse(json);
    return {...obj, date: new Date(obj.date)};    // JSON„Å´„Åô„Çã„Å®DateÂûã„ÅØÊñáÂ≠óÂàó„Å™„Å£„Å¶„Åó„Åæ„ÅÜ„ÅÆ„Åß„ÄÅDate„Å´Êàª„Åô
  } catch (err) {
    console.log("JSON error ", err);
    return {date: new Date(), message: ""};
  }
}
```


### Admin


```jsx
import { useState, useEffect } from 'react';
import useWebSocket, { ReadyState } from 'react-use-websocket';
import { MaintenanceNoticeType, jsonToMaintenanceNotice, maintenanceNoticeToJSon } from 'maintenance-notice';

const SocketUrl = "ws://localhost:4040";   // ‚Üê ‚ë†

export const App = () => {
  const [notices, setNotices] = useState<MaintenanceNoticeType[]>([]);      // ‚Üê ‚ë°
  const [message, setMessage] = useState("");                               // ‚Üê ‚ë¢
  const { sendMessage, lastMessage, readyState } = useWebSocket(SocketUrl); // ‚Üê ‚ë£

  useEffect(() => {
    if (lastMessage !== null) {  // ‚Üê ‚ë§
      const notice = jsonToMaintenanceNotice(lastMessage.data);
      if (notice.command && notice.command == "CLAER") {
        setNotices([]);
      } else {
        setNotices((prevNotice) => prevNotice.concat(notice));
      }
    }
  }, [lastMessage, setNotices]);

  switch (readyState) {   // ‚Üê ‚ë•
  case ReadyState.CLOSED:
    return <p>!! Server not running !!</p>
  case ReadyState.OPEN:
    return (             // ‚Üê ‚ë¶
      <>
        <input type="text" onChange={e => setMessage(e.target.value)} />
        <button onClick={_ => {
          sendMessage(maintenanceNoticeToJSon(new Date(), message));      // ‚Üê ‚ëß
        }}> Send </button>
        <button onClick={_ => {
          sendMessage(maintenanceNoticeToJSon(new Date(), "", "CLAER"));  // ‚Üê ‚ë®
        }}> Clear </button>
        <ul>
          {notices.map((notice, idx) => {       // ‚Üê ‚ë©
            const date = notice.date.toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" });
            return (
              <li key={idx}>
                <span style={{fontSize: '60%'}}>{date} </span>
                <span>{notice.message}</span>
              </li>
            );
          })}
        </ul>
      </>
    );
  default:     // ‚Üê ‚ë™
    return <p> CONNECTING, CLOSING, UNINSTANTIATED {readyState}</p>
  }
};

export default App;
```

- ‚ë† WebSocker„Çµ„Éº„Éê„Éº„ÅÆURL
- ‚ë° notices : „Çµ„Éº„Éê„Éº„Åã„ÇâÂèó‰ø°„Åó„ÅüÂÖ®ÈÄöÁü•„ÅÆState
- ‚ë¢ message : „É°„ÉÉ„Çª„Éº„Ç∏ÂÖ•ÂäõÁî®State
- ‚ë£ WebSocketÁî®Hook„ÄÅÊàª„ÇäÂÄ§„ÅØ
   - sendMessage : ÈÄÅ‰ø°Áî®Èñ¢Êï∞
   - lastMessage : ÊúÄÊñ∞„ÅÆÂèó‰ø°ÂÄ§
   - readyState : WebSocket„ÅÆÁä∂ÊÖã
- ‚ë§ WebSocket„ÇíÂèó‰ø°„Åó„ÅüÊôÇ„ÅÆÂá¶ÁêÜ
    - lastMessage.data„ÅØÂèó‰ø°„Åó„ÅüJSONÊñáÂ≠óÂàó„Åß„Åô
    - jsonToMaintenanceNotice()„ÅßJSONÊñáÂ≠óÂàó„ÇíÈÄöÁü•Âûã„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´Â§âÊèõ„Åó„Åæ„Åô
    - „ÇÇ„ÅóÈÄöÁü•„ÅåCLAER„Ç≥„Éû„É≥„Éâ„Å™„Çâ„ÄÅÂèó‰ø°„Åó„ÅüÈÄöÁü•State„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô
    - „Åù„Çå‰ª•Â§ñ„Å™„ÇâÂèó‰ø°„Åó„ÅüÈÄöÁü•State„ÅÆÊúÄÂæå„Å´ËøΩÂä†„Åó„Åæ„Åô
       - State„ÅÆsetÈñ¢Êï∞„ÅØ„Åì„ÅÆ„Çà„ÅÜ„Å´Èñ¢Êï∞„ÇíÊ∏°„Åô„Åì„Å®„ÇÇ„Åß„Åç„Åæ„Åô
       - „Åù„ÅÆÂ†¥Âêà„ÅØÂºïÊï∞„Å´ÁèæÂú®„ÅÆState„ÅåÊ∏°„Å£„Å¶„Åç„Åæ„Åô
- ‚ë• WebSocket„ÅÆÁä∂ÊÖã„Å´„Çà„ÇäÂá¶ÁêÜ„ÇíÂ§â„Åà„Å¶„ÅÑ„Åæ„Åô
     - ReadyState.CLOSED„ÅØ„Çµ„Éº„Éê„Éº„ÅåÂãï‰Ωú„Åó„Å¶„Å™„ÅÑÂ†¥Âêà„Å™„ÅÆ„Åß„ÄÅ„Ç®„É©„Éº„ÇíË°®Á§∫„Åó„Å¶„ÅÑ„Åæ„Åô
- ‚ë¶ WebSocket„ÅåÊé•Á∂öÊ∏à„ÅøÔºàÊ≠£Â∏∏Ôºâ„ÅÆÂ†¥Âêà„ÅÆÂá¶ÁêÜ
- ‚ëß Send„Éú„Çø„É≥„ÅåÊäº„Åï„Çå„ÅüÂ†¥Âêà„ÄÅinput„Çø„Ç∞„Å´ÂÖ•Âäõ„Åï„Çå„ÅüÊñáÂ≠óÂàó„Çímessage„Å®„Åó„Å¶„Çµ„Éº„Éê„Éº„Å´ÈÄÅ‰ø°„Åó„Å¶„ÅÑ„Åæ„Åô
- ‚ë® Clear„Éú„Çø„É≥„ÅåÊäº„Åï„Çå„ÅüÂ†¥Âêà„ÅØ„ÄÅCLAER„Ç≥„Éû„É≥„Éâ„Çí„Çµ„Éº„Éê„Éº„Å´ÈÄÅ‰ø°„Åó„Å¶„ÅÑ„Åæ„Åô
- ‚ë© Âèó‰ø°ÈÄöÁü•„ÅÆË°®Á§∫
   - date„ÅØÊó•Êú¨timezone„ÅßÊó•Êú¨ÁöÑ„Å™ÂΩ¢Âºè„ÅÆÊñáÂ≠óÂàó„Å´Â§âÊèõ„Åó„Å¶„ÅÑ„Åæ„Åô
- ‚ë™ CONNECTINGÔºàÊé•Á∂öÂá¶ÁêÜ‰∏≠Ôºâ„ÄÅCLOSINGÔºàÊé•Á∂öÁµÇ‰∫ÜÂá¶ÁêÜ‰∏≠Ôºâ„ÄÅUNINSTANTIATEDÔºàËµ∑ÂãïÂá¶ÁêÜ‰∏≠Ôºâ„ÅØÁÑ°Ë¶ñ„Åó„Å¶„ÅÑ„Åæ„Åô


### Server

```ts
import { WebSocketServer, WebSocket } from 'ws';
import { jsonToMaintenanceNotice } from 'maintenance-notice';

const wss = new WebSocketServer({ port: 4040 });  // ‚Üê ‚ë†

let connections: WebSocket[] = [];     // ‚Üê ‚ë°
let messageHistory: string[] = [];     // ‚Üê ‚ë¢

wss.on('connection', (ws) => {   // ‚Üê ‚ë£
  console.log('- connectioned ', connections.length);
  connections.push(ws);          // ‚Üê ‚ë§
  if (messageHistory.length > 0) {
    console.log('-  send history X ', messageHistory.length)
    messageHistory.forEach(message => ws.send(message));   // ‚Üê ‚ë•
  }

  ws.on('close', () => {                      // ‚Üê ‚ë¶
    const ix = connections.findIndex(conn => (conn === ws));   // ‚Üê ‚ëß
    console.log('- disconnectioned ', ix);
    if (ix >= 0) connections.splice(ix, 1);   // ‚Üê ‚ë®
  });

  ws.on('message', (data) =>  {                        // ‚Üê ‚ë©
    const message = data.toString();
    const notice = jsonToMaintenanceNotice(message);   // ‚Üê ‚ë™

    if (notice.command && notice.command == "CLAER") { // ‚Üê ‚ë´
      console.log('- clear history');
      messageHistory = [];
    } else {
      messageHistory.push(message);                    // ‚Üê ‚ë¨
    }

    console.log('- send message:', message, ' X ', connections.length);
    connections.forEach(con => con.send(message));     // ‚Üê ‚ë≠
  });

  ws.on('error', (err) => {            // ‚Üê ‚ëÆ
    console.error("= Error: ", err);
  });
});
```

- ‚ë† „Ç∑„É≥„Éó„É´„Å™WebSocket„Çµ„Éº„Éê„Éº„ÇíËµ∑Âãï
- ‚ë° connections : Êé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Çã„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÊé•Á∂öÊÉÖÂ†±ÔºàWebSocketÔºâ„ÅÆÈÖçÂàó
- ‚ë¢ messageHistory : ÈÅéÂéª„Å´ÈÄÅ‰ø°„Åó„ÅüÈÄöÁü•„Éá„Éº„ÇøÔºàJSONÊñáÂ≠óÂàóÔºâ„ÅÆÈÖçÂàó
- ‚ë£ „ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅåÊé•Á∂ö„Åï„Çå„Çã„Å®„ÄÅ„Åì„ÅÆÂá¶ÁêÜ„ÅåÂßã„Åæ„Çä„Åæ„Åô
   - ‚ë§ „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÊé•Á∂öÊÉÖÂ†±„Çíconnections„Å´ËøΩÂä†
   - ‚ë• Êé•Á∂öÂâç„Å´ÈÄÅ‰ø°„Åó„ÅüÈÄöÁü•„Éá„Éº„Çø„Åå„ÅÇ„Çå„Å∞„ÄÅÊé•Á∂ö„Åó„Åü„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Å´ÈÄÅ‰ø°
- ‚ë¶ „ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅÆÊé•Á∂ö„ÅåÂàá„Çå„Åü„Å®„Åç„Å´„ÄÅ„Åì„ÅÆÂá¶ÁêÜ„ÅåÂßã„Åæ„Çä„Åæ„Åô
   - ‚ëß Âàá„Çå„ÅüÊé•Á∂ö„ÇíË¶ã„Å§„Åë
   - ‚ë® „Åù„ÅÆÊé•Á∂ö„Çíconnections„Åã„ÇâÂâäÈô§„Åó„Åæ„Åô
- ‚ë© „É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèó‰ø°„Åó„Åü„Å®„Åç„Å´„ÄÅ„Åì„ÅÆÂá¶ÁêÜ„ÅåÂßã„Åæ„Çä„Åæ„Åô
   - ‚ë™ Âèó‰ø°„Éá„Éº„ÇøÔºàJSONÊñáÂ≠óÂàóÔºâ„ÇíÈÄöÁü•Âûã„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´Â§âÊèõ
   - ‚ë´ „ÇÇ„ÅóÈÄöÁü•„ÅåCLAER„Ç≥„Éû„É≥„Éâ„Å™„Çâ„ÄÅÂèó‰ø°„Åó„ÅümessageHistory„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô
   - ‚ë¨ „Åù„Çå‰ª•Â§ñ„Å™„ÇâÂèó‰ø°„Éá„Éº„Çø„ÇímessageHistory„Å´ËøΩÂä†
   - ‚ë≠ Âèó‰ø°„Éá„Éº„Çø„ÇíÊé•Á∂ö‰∏≠„ÅÆÂÖ®„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Å´ÈÄÅ‰ø°
- ‚ëÆ „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åü„Å®„Åç„Å´„ÄÅ„Åì„ÅÆÂá¶ÁêÜ„ÅåÂßã„Åæ„Çä„Åæ„Åô


### Client

UI„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü„ÄÇüîî

##### 1. useMaintenanceNotice.ts

WebSocket„Å®„ÅÆÈÄö‰ø°ÈÉ®ÂàÜ„ÅØHook„Å´„Åó„Åæ„Åó„Åü„ÄÇ

```ts

import { MaintenanceNoticeType, jsonToMaintenanceNotice } from 'maintenance-notice';
import { useEffect, useState } from 'react';
import useWebSocket, { ReadyState } from 'react-use-websocket';

const SocketUrl = "ws://localhost:4040";                                 // ‚Üê ‚ë†

// useMaintenanceNotice„ÅÆÊàª„ÇäÂÄ§„ÅÆÂûã
type UseMaintenanceNoticeReturnType = {
  notices: MaintenanceNoticeType[],        // MaintenanceNotice„ÅÆÈÖçÂàó
  socketError: boolean                     // ÈÄö‰ø°„Ç®„É©„ÉºÁô∫Áîü
}
// ÈÄöÁü•„ÇíWebScoket„ÅßÂèó„ÅëÂèñ„ÇãHook

const useMaintenanceNotice = (): UseMaintenanceNoticeReturnType => {
  const [notices, setNotices] = useState<MaintenanceNoticeType[]>([]);   // ‚Üê ‚ë°
  const { lastMessage, readyState } = useWebSocket(SocketUrl);           // ‚Üê ‚ë¢

  useEffect(() => {                                                      // ‚Üê ‚ë£
    if (lastMessage !== null) {
      const notice = jsonToMaintenanceNotice(lastMessage.data);
      if (notice.command && notice.command === "CLAER") {
        setNotices([]);
      } else {
        setNotices((prevNotice) => prevNotice.concat(notice));
      }
    }
  }, [lastMessage, setNotices]);

  if (readyState === ReadyState.CLOSED) {
    return {notices: [], socketError: true};         // ‚Üê ‚ë§
  } else {
    return {notices, socketError: false};            // ‚Üê ‚ë•
  }
}

export default useMaintenanceNotice
```


- ‚ë† WebSocker„Çµ„Éº„Éê„Éº„ÅÆURL
- ‚ë° notices : „Çµ„Éº„Éê„Éº„Åã„ÇâÂèó‰ø°„Åó„ÅüÂÖ®ÈÄöÁü•„ÅÆState
- ‚ë¢ WebSocketÁî®Hook„ÄÅÊàª„ÇäÂÄ§„ÅØ
   - lastMessage : ÊúÄÊñ∞„ÅÆÂèó‰ø°ÂÄ§
   - readyState : WebSocket„ÅÆÁä∂ÊÖã
- ‚ë£ WebSocket„ÇíÂèó‰ø°„Åó„ÅüÊôÇ„ÅÆÂá¶ÁêÜ„ÅØ`useEffect`„Çí‰Ωø„Å£„Å¶ lastMessage „ÅÆÂ§âÊõ¥ÊôÇ„Å´Ë°å„Çè„Çå„Åæ„Åô
   - lastMessage.data„ÅØÂèó‰ø°„Åó„ÅüJSONÊñáÂ≠óÂàó„Åß„Åô
   - jsonToMaintenanceNotice()„ÅßJSONÊñáÂ≠óÂàó„ÇíÈÄöÁü•Âûã„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´Â§âÊèõ„Åó„Åæ„Åô
   - „ÇÇ„ÅóÈÄöÁü•„ÅåCLAER„Ç≥„Éû„É≥„Éâ„Å™„Çâ„ÄÅÂèó‰ø°„Åó„ÅüÈÄöÁü•State„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô
   - „Åù„Çå‰ª•Â§ñ„Å™„ÇâÂèó‰ø°„Åó„ÅüÈÄöÁü•State„ÅÆÊúÄÂæå„Å´ËøΩÂä†„Åó„Åæ„Åô
- ‚ë§ ReadyState.CLOSED„ÅØ„Çµ„Éº„Éê„Éº„ÅåÂãï‰Ωú„Åó„Å¶„Å™„ÅÑÂ†¥Âêà„Å™„ÅÆ„Åß„Ç®„É©„Éº„ÇíÊàª„Åó„Åæ„Åô
- ‚ë• „Åù„Çå‰ª•Â§ñ„ÅÆÁä∂ÊÖã„ÅØnotices„ÇíÊàª„Åó„Åæ„Åô

#### 2. App.tsx

UI„Å´„ÅØ‰ª•‰∏ã„Çí‰Ωø„Å£„Å¶„ÅÑ„Åæ„Åô

- IconButton„ÄÄ„Ç¢„Ç§„Ç≥„É≥„Éú„Çø„É≥
- Badge„ÄÄ„Éê„ÉÉ„Ç∏ÔºàÂè≥‰∏ä„ÅÆÔºâ‰ª∂Êï∞Ë°®Á§∫
- Card„ÄÄÈÄöÁü•„É™„Çπ„ÉàË°®Á§∫„ÅÆÊû†
- Alert¬†ÈÄöÁü•Ôºà„Ç¢„É©„Éº„ÉàÔºâË°®Á§∫
- Slide„ÄÄÈÄöÁü•Ë°®Á§∫„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÅÆÁßªÂãï„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥

```jsx
import React, { useState } from "react";
import useMaintenanceNotice from "./useMaintenanceNotice";
import { MaintenanceNoticeType } from "maintenance-notice";

import { AppBar, Badge, Button, Card, CardContent, CardHeader, IconButton, makeStyles, Slide, Toolbar, Typography } from "@material-ui/core";
import { Alert } from '@material-ui/lab';
import CloseIcon             from '@material-ui/icons/Close';
import NotificationsIcon     from '@material-ui/icons/Notifications';
import NotificationsNoneIcon from '@material-ui/icons/NotificationsNone';

// ÈÄöÁü•„É™„Çπ„ÉàË°®Á§∫„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà               // ‚Üê ‚ë†
type MaintenanceNoticeAlertProps = {
  notices: MaintenanceNoticeType[],
  onClose: () => void
}
const MaintenanceNoticeAlerts: React.FC<MaintenanceNoticeAlertProps> = ({notices, onClose}) => {
  return (
    <Card>
      <CardHeader
        title="ÈÄöÁü•"
        action={
          <IconButton onClick={_ => onClose()} color="primary" aria-label="upload picture" component="span">
            <CloseIcon />
          </IconButton>
        }
      />
      <CardContent>
        {notices.map((notice, idx) => {
          const date = notice.date.toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" });
          return (
            <Alert key={idx} style={{marginBottom: 10}} severity="warning"><span style={{fontSize: '60%'}}>{date} </span> ‚Äî <span>{notice.message}</span></Alert>
          );
        })}
      </CardContent>
    </Card>
  )
}

// ÈÄöÁü•„Ç¢„Ç§„Ç≥„É≥                            // ‚Üê ‚ë°
type NotificationsBellIconProps = {
  notices: MaintenanceNoticeType[],
  socketError: boolean
}
const NotificationsBellIcon: React.FC<NotificationsBellIconProps> = ({socketError, notices}) => {
  if (socketError) {
    return <NotificationsIcon color="error" />;
  } else if (notices.length === 0) {
    return <NotificationsNoneIcon />;
  } else {
    return <NotificationsIcon />;
  }
};


const App = () => {
  const {notices, socketError} = useMaintenanceNotice();     // ‚Üê ‚ë¢
  const [showNotice, setShowNotice] = useState(false);       // ‚Üê ‚ë£

  const useStyles = makeStyles((theme) => ({
    root: {
      flexGrow: 1,
    },
    menuButton: {
      marginRight: theme.spacing(2),
    },
    title: {
      flexGrow: 1,
    },
    work: {
      margin: 10
    }
  }));

  const classes = useStyles();

  return (
    <div>
      <AppBar position="static">
        <Toolbar>
          <Typography variant="h6" className={classes.title}>
            Apps
          </Typography>
          <IconButton onClick={_ => setShowNotice(!showNotice)} color="inherit">  // ‚Üê ‚ë§
            <Badge badgeContent={notices.length} color="secondary">
              <NotificationsBellIcon notices={notices} socketError={socketError} />
            </Badge>
          </IconButton>
          <Button color="inherit">Logout</Button>
        </Toolbar>
      </AppBar>
      <div className={classes.work}>
        {socketError ?                                         // ‚Üê ‚ë•
          <Alert severity="error">ÈÄöÁü•„Çµ„Éº„Éê„Éº„Åæ„Åü„ÅØ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Å´ÂïèÈ°å„ÅåÁô∫Áîü„Åó„Å¶„ÅÑ„Åæ„Åô</Alert> :
          <Slide direction="up" in={showNotice && notices.length > 0} mountOnEnter unmountOnExit>  // ‚Üê ‚ë¶
            <div>
              <MaintenanceNoticeAlerts notices={notices} onClose={() => setShowNotice(false)}/>  // ‚Üê ‚ëß
            </div>
          </Slide>
        }
      </div>
    </div>
  )
}

export default App;
```

- ‚ë† ÈÄöÁü•„É™„Çπ„Éà„ÇíË°®Á§∫„Åô„Çã„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
    - Card(MUI)„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÅÆ‰∏ä„Å´ÈÄöÁü•„É™„Çπ„Éà„ÇíË°®Á§∫„Åó„Å¶„ÅÑ„Åæ„Åô
    - 1„Å§„ÅÆÈÄöÁü•„ÅØAlert(MUI)„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Çí‰Ωø„Å£„Å¶„ÅÑ„Åæ„Åô
    - Èñâ„Åò„Çã„Éú„Çø„É≥„Åå„ÅÇ„Çä„Åæ„Åô
- ‚ë° ÈÄöÁü•„Ç¢„Ç§„Ç≥„É≥„ÇíË°®Á§∫„Åô„Çã„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
    - „Ç®„É©„Éº„ÄÅÈÄöÁü•ÁÑ°„Åó„ÄÅÈÄöÁü•Êúâ„Çä„ÅßË°®Á§∫„Åô„Çã„Ç¢„Ç§„Ç≥„É≥„ÇíÂàá„ÇäÊõø„Åà„Å¶„ÅÑ„Åæ„Åô
- ‚ë¢ useMaintenanceNoticeÂëº„Å≥Âá∫„Åó
    - ÈÄöÁü•„ÅÆÈÖçÂàó„Å®ÈÄö‰ø°„Ç®„É©„Éº„ÅåÊàª„Çä„Åæ„Åô
    - ÈÄöÁü•„ÇíÂèó„ÅëÂèñ„Çã„Å®App„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÅØÂÜçÊèèÁîª„Åï„Çå„Åæ„Åô
- ‚ë£ ÈÄöÁü•„É™„Çπ„ÉàË°®Á§∫On/Off„ÅÆState
- ‚ë§ ÈÄöÁü•ICON
    - „ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®ÈÄöÁü•„É™„Çπ„Éà„ÇíË°®Á§∫„Åó„Åæ„Åô
    - ÈÄöÁü•‰ª∂Êï∞„ÅåBadge„ÅßÂè≥‰∏ä„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô
    - „Ç¢„Ç§„Ç≥„É≥„ÅØ„Ç®„É©„Éº„ÄÅÈÄöÁü•ÁÑ°„Åó„ÄÅÈÄöÁü•Êúâ„ÅßÂ§â„Çè„Çä„Åæ„Åô
- ‚ë• ÈÄö‰ø°„Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØ„Ç®„É©„ÉºAlert(MUI)„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
- ‚ë¶ ÈÄöÁü•„É™„Çπ„Éà„ÇíË°®Á§∫„Åô„ÇãÈöõ„Å´ÁßªÂãïÂûã„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Åå‰Ωø„Çè„Çå„Åæ„Åô
    - ÈÄö‰ø°„Ç®„É©„Éº„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫„Åï„Çå„Åæ„Åô
    - „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅØSlide(MUI)„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Çí‰Ωø„Å£„Å¶„ÅÑ„Åæ„Åô
- ‚ëß ÈÄöÁü•„É™„Çπ„ÉàË°®Á§∫„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÇíÂà©Áî®

## „Ç§„É≥„Çπ„Éà„Éº„É´„ÉªËµ∑ÂãïÊñπÊ≥ï

### 1. „Ç§„É≥„Çπ„Éà„Éº„É´„Å®maintenance-notice

```sh
$ git clone https://github.com/yuumi3/ws_sample
$ cd ws_sample
$ cd maintenance-notice
$ npm install
$ npm start
$ 
```

### 2. Server

```sh
$ cd ../server
$ npm install
$ npm start

> server@1.0.0 start
> ts-node src/index.ts
```

### 3. Admin

Âà•„Çø„Éº„Éü„Éä„É´„ÇíËµ∑Âãï„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

```sh
$ cd ws_sample
$ cd admin
$ npm install
$ npm start

„Éª„Éª„Éª

You can now view client in the browser.

  Local:            http://localhost:3010
  On Your Network:  http://192.168.3.36:3010

Note that the development build is not optimized.
To create a production build, use npm run build.

webpack compiled successfully
Files successfully emitted, waiting for typecheck results...
Issues checking in progress...
No issues found.
```

„Éñ„É©„Ç¶„Ç∂„Éº„Åß `http://localhost:3010` „Çí„Ç¢„ÇØ„Çª„Çπ„Åô„Çã„Å®‰∏ã„ÅÆ„Çà„ÅÜ„Å™ÁîªÈù¢„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ

![](/images/admin1.png)

ÂÖ•ÂäõÊ¨Ñ„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„ÄÅSend„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„ÄÅ‰∏ã„ÅÆ„Çà„ÅÜ„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ

![](/images/admin2.png)

### 3. Client

Âà•„Çø„Éº„Éü„Éä„É´„ÇíËµ∑Âãï„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ


```sh
$ cd ws_sample
$ cd admin
$ npm install
$ npm start

„Éª„Éª„Éª

You can now view client in the browser.

  Local:            http://localhost:3000
  On Your Network:  http://192.168.3.36:3000

Note that the development build is not optimized.
To create a production build, use npm run build.

webpack compiled successfully
Files successfully emitted, waiting for typecheck results...
Issues checking in progress...
No issues found.
```

„Éñ„É©„Ç¶„Ç∂„Éº„Åß `http://localhost:3000` „Çí„Ç¢„ÇØ„Çª„Çπ„Åô„Çã„Å®‰∏ã„ÅÆ„Çà„ÅÜ„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ

![](/images/client1.png)


## License

[MIT License](http://www.opensource.org/licenses/MIT).
